@echo off
REM Complete Malware Testing Script - Windows
REM Author: Manoj Santhoju
REM This script handles everything: simulation, dump creation, analysis, cleanup

echo ==========================================
echo COMPLETE MALWARE TESTING SCRIPT
echo ==========================================
echo.

REM Activate virtual environment
if exist venv\Scripts\activate.bat (
    call venv\Scripts\activate.bat
) else (
    echo ERROR: Virtual environment not found. Run setup_windows.bat first.
    pause
    exit /b 1
)

REM Step 1: Clean up previous test artifacts
echo [1] Cleaning up previous test artifacts...
if exist malware_test_environment (
    rmdir /s /q malware_test_environment
)
if exist memory_dump_with_malware.raw (
    del /q memory_dump_with_malware.raw
)
echo SUCCESS: Cleanup completed

REM Step 2: Run malware simulation
echo.
echo [2] Running malware simulation...
py test_malware_simulation.py
if %errorlevel% neq 0 (
    echo ERROR: Malware simulation failed
    pause
    exit /b 1
)
echo SUCCESS: Malware simulation completed

REM Step 3: Create memory dump with malware artifacts
echo.
echo [3] Creating memory dump with malware artifacts...
py create_malware_memory_dump.py --filename memory_dump_with_malware.raw --os-type windows --size 50
if %errorlevel% neq 0 (
    echo ERROR: Failed to create memory dump
    pause
    exit /b 1
)
echo SUCCESS: Memory dump created

REM Step 4: Run basic analysis
echo.
echo [4] Running basic memory analysis...
py -m unified_forensics analyze memory_dump_with_malware.raw --os-type windows --plugins malware,network --format summary --metrics
if %errorlevel% neq 0 (
    echo WARNING: Basic analysis had issues (continuing...)
) else (
    echo SUCCESS: Basic analysis completed
)

REM Step 5: Ask user for graph type
echo.
echo [5] Graph Generation Options
echo.
echo Choose graph type:
echo   1. Basic (3 event rates: 1, 10, 20)
echo   2. Full (8 event rates: 1, 10, 20, 50, 80, 100, 125, 200)
echo.
set /p GRAPH_TYPE="Enter choice (1 or 2): "

if "%GRAPH_TYPE%"=="1" (
    echo.
    echo Running basic experimental analysis...
    py -m unified_forensics experiment memory_dump_with_malware.raw --os-type windows --rates 1 --rates 10 --rates 20 --output analysis_results\malware_test_complete.json
    if %errorlevel% neq 0 (
        echo WARNING: Experimental analysis had issues
    ) else (
        echo SUCCESS: Basic experimental analysis completed
    )
) else if "%GRAPH_TYPE%"=="2" (
    echo.
    echo Running full experimental analysis...
    py -m unified_forensics experiment memory_dump_with_malware.raw --os-type windows --rates 1 --rates 10 --rates 20 --rates 50 --rates 80 --rates 100 --rates 125 --rates 200 --output analysis_results\malware_test_complete.json
    if %errorlevel% neq 0 (
        echo WARNING: Experimental analysis had issues
    ) else (
        echo SUCCESS: Full experimental analysis completed
    )
) else (
    echo.
    echo Invalid choice. Running basic analysis by default...
    py -m unified_forensics experiment memory_dump_with_malware.raw --os-type windows --rates 1 --rates 10 --rates 20 --output analysis_results\malware_test_complete.json
    if %errorlevel% neq 0 (
        echo WARNING: Experimental analysis had issues
    ) else (
        echo SUCCESS: Experimental analysis completed
    )
)

REM Step 6: Check results
echo.
echo [6] Checking results...
if exist performance_charts\detection_performance_windows_*.png (
    echo SUCCESS: Performance charts generated!
    echo.
    echo Charts:
    dir /b performance_charts\detection_performance_windows_*.png
) else (
    echo WARNING: No performance charts found
)

if exist analysis_results\malware_test_complete.json (
    echo SUCCESS: Analysis results saved
) else (
    echo WARNING: No analysis results found
)

REM Step 7: Ask about cleanup
echo.
echo ==========================================
echo TESTING COMPLETE
echo ==========================================
echo.
echo Results:
echo   - Memory dump: memory_dump_with_malware.raw
echo   - Analysis results: analysis_results\malware_test_complete.json
echo   - Performance charts: performance_charts\
echo   - Test artifacts: malware_test_environment\
echo.
set /p CLEANUP="Do you want to clean up test artifacts? (y/n): "
if /i "%CLEANUP%"=="y" (
    echo.
    echo Cleaning up...
    py test_malware_simulation.py --cleanup
    if exist memory_dump_with_malware.raw (
        del /q memory_dump_with_malware.raw
    )
    echo SUCCESS: Cleanup completed
) else (
    echo.
    echo Test artifacts preserved for review.
    echo To clean up later, run: py test_malware_simulation.py --cleanup
)

echo.
echo ==========================================
echo ALL DONE!
echo ==========================================
pause
