#!/bin/bash
# Complete Malware Testing Script - Linux
# Author: Manoj Santhoju
# This script handles everything: simulation, dump creation, analysis, cleanup

echo "=========================================="
echo "COMPLETE MALWARE TESTING SCRIPT (Linux)"
echo "=========================================="
echo ""

# Activate virtual environment
if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
else
    echo "ERROR: Virtual environment not found. Run setup_linux.sh first."
    exit 1
fi

# Step 1: Clean up previous test artifacts
echo "[1] Cleaning up previous test artifacts..."
if [ -d "malware_test_environment" ]; then
    rm -rf malware_test_environment
fi
if [ -f "memory_dump_with_malware.raw" ]; then
    rm -f memory_dump_with_malware.raw
fi
echo "SUCCESS: Cleanup completed"

# Step 2: Run malware simulation
echo ""
echo "[2] Running malware simulation..."
python3 test_malware_simulation.py
if [ $? -ne 0 ]; then
    echo "ERROR: Malware simulation failed"
    exit 1
fi
echo "SUCCESS: Malware simulation completed"

# Step 3: Create memory dump with malware artifacts
echo ""
echo "[3] Creating memory dump with malware artifacts..."
python3 create_malware_memory_dump.py --filename memory_dump_with_malware.raw --os-type linux --size 50
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to create memory dump"
    exit 1
fi
echo "SUCCESS: Memory dump created"

# Step 4: Run basic analysis
echo ""
echo "[4] Running basic memory analysis..."
python3 -m unified_forensics analyze memory_dump_with_malware.raw --os-type linux --plugins malware,network --format summary --metrics
if [ $? -ne 0 ]; then
    echo "WARNING: Basic analysis had issues (continuing...)"
else
    echo "SUCCESS: Basic analysis completed"
fi

# Step 5: Run full experimental analysis (automatic for Linux)
echo ""
echo "[5] Running full experimental analysis..."
echo "   (Full: 8 event rates: 1, 10, 20, 50, 80, 100, 125, 200)"
    python3 -m unified_forensics experiment memory_dump_with_malware.raw --os-type linux --rates 1 --rates 10 --rates 20 --rates 50 --rates 80 --rates 100 --rates 125 --rates 200 --output analysis_results/malware_test_complete.json
    if [ $? -ne 0 ]; then
        echo "WARNING: Experimental analysis had issues"
    else
        echo "SUCCESS: Full experimental analysis completed"
fi

# Step 6: Check results
echo ""
echo "[6] Checking results..."
if ls performance_charts/detection_performance_linux_*.png 1> /dev/null 2>&1; then
    echo "SUCCESS: Performance charts generated!"
    echo ""
    echo "Charts:"
    ls -1 performance_charts/detection_performance_linux_*.png
else
    echo "WARNING: No performance charts found"
fi

if [ -f "analysis_results/malware_test_complete.json" ]; then
    echo "SUCCESS: Analysis results saved"
else
    echo "WARNING: No analysis results found"
fi

# Step 7: Ask about cleanup
echo ""
echo "=========================================="
echo "TESTING COMPLETE"
echo "=========================================="
echo ""
echo "Results:"
echo "  - Memory dump: memory_dump_with_malware.raw"
echo "  - Analysis results: analysis_results/malware_test_complete.json"
echo "  - Performance charts: performance_charts/"
echo "  - Test artifacts: malware_test_environment/"
echo ""
read -p "Do you want to clean up test artifacts? (y/n): " CLEANUP

if [ "$CLEANUP" == "y" ] || [ "$CLEANUP" == "Y" ]; then
    echo ""
    echo "Cleaning up..."
    python3 test_malware_simulation.py --cleanup
    if [ -f "memory_dump_with_malware.raw" ]; then
        rm -f memory_dump_with_malware.raw
    fi
    echo "SUCCESS: Cleanup completed"
else
    echo ""
    echo "Test artifacts preserved for review."
    echo "To clean up later, run: python3 test_malware_simulation.py --cleanup"
fi

echo ""
echo "=========================================="
echo "ALL DONE!"
echo "=========================================="

