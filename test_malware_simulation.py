#!/usr/bin/env python3
"""
Safe Malware Simulation Script for Testing
Author: Manoj Santhoju
Institution: National College of Ireland

WARNING: This script simulates malware-like behaviors for testing purposes only.
It does NOT contain actual malware. Use only in controlled environments.
"""

import os
import sys
import time
import random
import subprocess
import platform
from pathlib import Path
from datetime import datetime

class MalwareSimulator:
    """Simulates malware-like behaviors for testing memory forensics"""
    
    def __init__(self):
        self.test_dir = Path("malware_test_environment")
        self.suspicious_files = []
        self.suspicious_processes = []
        self.test_log = []
        
    def create_test_environment(self):
        """Create isolated test environment"""
        print("[*] Creating isolated test environment...")
        # Clean up existing directory if it exists
        if self.test_dir.exists():
            import shutil
            shutil.rmtree(self.test_dir)
        self.test_dir.mkdir(exist_ok=True)
        print(f"[+] Test environment created: {self.test_dir}")
        
    def simulate_suspicious_file_operations(self):
        """Simulate suspicious file operations"""
        print("[*] Simulating suspicious file operations...")
        
        # Create suspicious files
        suspicious_names = [
            "suspicious_encrypted.dat",
            "temp_credentials.txt",
            "stolen_data.bin",
            "keylogger_output.log",
            "backdoor_config.cfg"
        ]
        
        for filename in suspicious_names:
            filepath = self.test_dir / filename
            with open(filepath, 'wb') as f:
                # Write random data (simulating encrypted or stolen data)
                f.write(os.urandom(random.randint(1024, 10240)))
            self.suspicious_files.append(filepath)
            self.test_log.append(f"Created suspicious file: {filepath}")
            print(f"[+] Created: {filepath}")
            
        # Modify files multiple times (simulating data exfiltration)
        for i in range(3):
            for filepath in self.suspicious_files[:2]:
                with open(filepath, 'ab') as f:
                    f.write(b'MODIFIED_DATA_' + str(i).encode())
                time.sleep(0.1)
            self.test_log.append(f"Modified files (iteration {i+1})")
            
        # Copy files (simulating data theft)
        for i, filepath in enumerate(self.suspicious_files[:2]):
            copy_path = self.test_dir / f"copy_{filepath.name}"
            with open(filepath, 'rb') as src, open(copy_path, 'wb') as dst:
                dst.write(src.read())
            self.test_log.append(f"Copied file: {filepath} -> {copy_path}")
            print(f"[+] Copied: {copy_path}")
            
        # Rename files (simulating evasion)
        if self.suspicious_files:
            old_path = self.suspicious_files[0]
            new_path = self.test_dir / "hidden_file.dat"
            # Remove target if it exists
            if new_path.exists():
                new_path.unlink()
            if old_path.exists():
                old_path.rename(new_path)
                self.suspicious_files[0] = new_path
                self.test_log.append(f"Renamed file: {old_path} -> {new_path}")
                print(f"[+] Renamed: {new_path}")
            
    def simulate_suspicious_processes(self):
        """Simulate suspicious process behaviors"""
        print("[*] Simulating suspicious process behaviors...")
        
        if platform.system() == "Windows":
            # Windows-specific suspicious behaviors
            self._simulate_windows_processes()
        elif platform.system() == "Linux":
            # Linux-specific suspicious behaviors
            self._simulate_linux_processes()
        elif platform.system() == "Darwin":  # macOS
            # macOS-specific suspicious behaviors
            self._simulate_macos_processes()
            
    def _simulate_windows_processes(self):
        """Windows-specific process simulation"""
        # Create a benign script that runs suspicious-looking commands
        script_content = '''
import time
import os
import socket

# Simulate suspicious network activity
try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(1)
    sock.connect(("127.0.0.1", 8080))
except:
    pass

# Simulate suspicious file access
for i in range(10):
    with open("temp_test.dat", "wb") as f:
        f.write(os.urandom(1024))
    time.sleep(0.1)
    if os.path.exists("temp_test.dat"):
        os.remove("temp_test.dat")
'''
        script_path = self.test_dir / "suspicious_process.py"
        with open(script_path, 'w') as f:
            f.write(script_content)
            
        # Run the script
        try:
            process = subprocess.Popen(
                [sys.executable, str(script_path)],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                cwd=str(self.test_dir)
            )
            self.suspicious_processes.append(process)
            self.test_log.append(f"Started suspicious process: {process.pid}")
            print(f"[+] Started suspicious process: PID {process.pid}")
            time.sleep(2)
            process.terminate()
        except Exception as e:
            print(f"[!] Process simulation error: {e}")
            
    def _simulate_linux_processes(self):
        """Linux-specific process simulation"""
        # Similar to Windows but with Linux-specific paths
        script_content = '''
import time
import os
import socket

# Simulate suspicious network activity
try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(1)
    sock.connect(("127.0.0.1", 8080))
except:
    pass

# Simulate suspicious file access
for i in range(10):
    with open("temp_test.dat", "wb") as f:
        f.write(os.urandom(1024))
    time.sleep(0.1)
    if os.path.exists("temp_test.dat"):
        os.remove("temp_test.dat")
'''
        script_path = self.test_dir / "suspicious_process.py"
        with open(script_path, 'w') as f:
            f.write(script_content)
            
        try:
            process = subprocess.Popen(
                [sys.executable, str(script_path)],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                cwd=str(self.test_dir)
            )
            self.suspicious_processes.append(process)
            self.test_log.append(f"Started suspicious process: {process.pid}")
            print(f"[+] Started suspicious process: PID {process.pid}")
            time.sleep(2)
            process.terminate()
        except Exception as e:
            print(f"[!] Process simulation error: {e}")
            
    def _simulate_macos_processes(self):
        """macOS-specific process simulation"""
        # Similar to Linux
        self._simulate_linux_processes()
        
    def simulate_network_activity(self):
        """Simulate suspicious network connections"""
        print("[*] Simulating suspicious network activity...")
        
        import socket
        
        # Attempt connections to suspicious ports (simulating C2 communication)
        suspicious_ports = [8080, 4444, 5555, 6666]
        
        for port in suspicious_ports:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(0.5)
                result = sock.connect_ex(("127.0.0.1", port))
                sock.close()
                self.test_log.append(f"Attempted connection to port {port}")
                print(f"[+] Attempted connection to port {port}")
            except Exception as e:
                pass
                
        time.sleep(1)
        
    def simulate_registry_modifications(self):
        """Simulate registry/configuration modifications (Windows)"""
        if platform.system() == "Windows":
            print("[*] Simulating registry-like modifications...")
            # Create a fake registry export file
            reg_file = self.test_dir / "suspicious_registry.reg"
            with open(reg_file, 'w') as f:
                f.write("Windows Registry Editor Version 5.00\n")
                f.write("[HKEY_CURRENT_USER\\Software\\TestKey]\n")
                f.write('"SuspiciousValue"="TestData"\n')
            self.test_log.append("Created registry-like modification file")
            print(f"[+] Created: {reg_file}")
            
    def generate_test_report(self):
        """Generate test activity report"""
        report_path = self.test_dir / "malware_simulation_report.txt"
        with open(report_path, 'w') as f:
            f.write("MALWARE SIMULATION TEST REPORT\n")
            f.write("=" * 50 + "\n")
            f.write(f"Timestamp: {datetime.now().isoformat()}\n")
            f.write(f"Platform: {platform.system()}\n")
            f.write(f"Python: {sys.version}\n\n")
            f.write("SIMULATED ACTIVITIES:\n")
            f.write("-" * 50 + "\n")
            for log_entry in self.test_log:
                f.write(f"{log_entry}\n")
            f.write("\n")
            f.write("SUSPICIOUS FILES CREATED:\n")
            f.write("-" * 50 + "\n")
            for filepath in self.suspicious_files:
                f.write(f"{filepath}\n")
            f.write("\n")
            f.write("SUSPICIOUS PROCESSES:\n")
            f.write("-" * 50 + "\n")
            for process in self.suspicious_processes:
                f.write(f"PID: {process.pid}\n")
        print(f"[+] Test report generated: {report_path}")
        return report_path
        
    def cleanup(self):
        """Clean up test environment"""
        print("[*] Cleaning up test environment...")
        
        # Terminate any running processes
        for process in self.suspicious_processes:
            try:
                process.terminate()
                process.wait(timeout=5)
            except:
                try:
                    process.kill()
                except:
                    pass
                    
        # Remove test directory
        if self.test_dir.exists():
            import shutil
            shutil.rmtree(self.test_dir, ignore_errors=True)
            print(f"[+] Cleaned up: {self.test_dir}")
            
    def run_simulation(self):
        """Run complete malware simulation"""
        print("=" * 60)
        print("MALWARE SIMULATION TEST - FOR EDUCATIONAL PURPOSES ONLY")
        print("=" * 60)
        print()
        print("WARNING: This script simulates malware-like behaviors.")
        print("It does NOT contain actual malware.")
        print("Use only in controlled, isolated environments.")
        print()
        time.sleep(2)
        
        try:
            self.create_test_environment()
            self.simulate_suspicious_file_operations()
            self.simulate_suspicious_processes()
            self.simulate_network_activity()
            self.simulate_registry_modifications()
            report_path = self.generate_test_report()
            
            print()
            print("=" * 60)
            print("SIMULATION COMPLETE")
            print("=" * 60)
            print(f"[+] Test report: {report_path}")
            print("[*] You can now create a memory dump to test forensics.")
            print("[*] Run cleanup script to remove test artifacts.")
            print()
            
        except Exception as e:
            print(f"[!] Simulation error: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    simulator = MalwareSimulator()
    
    if len(sys.argv) > 1 and sys.argv[1] == "--cleanup":
        simulator.cleanup()
        print("[+] Cleanup complete")
    else:
        simulator.run_simulation()
        
        # Ask user if they want to clean up
        print()
        response = input("Do you want to clean up now? (y/n): ").lower()
        if response == 'y':
            simulator.cleanup()
            print("[+] Cleanup complete")
        else:
            print("[*] Test artifacts remain. Run with --cleanup to remove them.")
